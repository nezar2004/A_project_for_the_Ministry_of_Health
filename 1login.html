<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù†Ø¨Ø¶ - ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #8D6E63;
      --secondary: #A1887F;
      --accent: #6D4C41;
      --bg: #F5F5F5;
    }
    body {
      font-family: "Tajawal", sans-serif;
      background-color: #D7CCC8;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 400px;
      color: #3E2723;
    }
    h2 { text-align: center; margin-bottom: 20px; color: var(--accent); }
    input, select {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: 1px solid #ddd;
      border-radius: 10px;
      font-size: 14px;
      box-sizing: border-box;
      font-family: 'Tajawal';
    }
    .phone-container { display: flex; gap: 10px; }
    .phone-container select { width: 35%; }
    .phone-container input { width: 65%; }
    
    button {
      width: 100%;
      padding: 12px;
      background-color: var(--accent);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 10px;
      transition: 0.3s;
    }
    button:hover { background-color: var(--primary); }
    button:disabled { background-color: #ccc; cursor: not-allowed; }
    
    .link {
      text-align: center;
      margin-top: 15px;
      color: var(--primary);
      cursor: pointer;
      font-size: 14px;
    }
    .link:hover { text-decoration: underline; }
    .hidden { display: none; }
    #recaptcha-container { margin: 10px 0; display: flex; justify-content: center; }
    .otp-box { border: 2px solid var(--primary); padding: 10px; border-radius: 10px; margin-top: 10px; }
  </style>
</head>
<body>

<div class="container">
  
  <div id="loginForm">
    <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
    <input type="email" id="loginEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
    <input type="password" id="loginPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
    <button id="loginBtn">Ø¯Ø®ÙˆÙ„</button>
    <div class="link" onclick="toggleForms()">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</div>
    <div class="link" onclick="showForgot()">Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ (Ø¹Ø¨Ø± Ø§Ù„Ù‡Ø§ØªÙ)</div>
  </div>

  <div id="registerForm" class="hidden">
    <h2>Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</h2>
    <input type="text" id="firstName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„">
    <input type="text" id="lastName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©">
    
    <div class="phone-container">
      <select id="countryCode">
        <option value="+962">ğŸ‡¯ğŸ‡´ +962</option>
      </select>
      <input type="text" id="phone" placeholder="7XXXXXXXX">
    </div>

    <input type="email" id="regEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
    <input type="date" id="birthday">
    
    <select id="gender">
      <option value="">Ø§Ù„Ø¬Ù†Ø³</option>
      <option value="male">Ø°ÙƒØ±</option>
      <option value="female">Ø£Ù†Ø«Ù‰</option>
    </select>

    <input type="password" id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
    <input type="password" id="confirmPassword" placeholder="ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
    
    <button id="registerBtn">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨</button>
    <div class="link" onclick="toggleForms()">Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ</div>
  </div>

  <div id="forgotForm" class="hidden">
    <h2>Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
    <p style="font-size: 12px; text-align: center;">Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ Ø§Ù„Ù…Ø³Ø¬Ù„ Ù„ØªØµÙ„Ùƒ Ø±Ø³Ø§Ù„Ø© Ù†ØµÙŠØ© Ø¨ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„</p>
    
    <div class="phone-container">
      <select id="recoverCountryCode">
        <option value="+962">ğŸ‡¯ğŸ‡´ +962</option>
      </select>
      <input type="text" id="recoverPhone" placeholder="7XXXXXXXX">
    </div>

    <div id="recaptcha-container"></div>

    <button id="sendOtpBtn">Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚</button>

    <div id="otpSection" class="hidden" class="otp-box">
      <input type="text" id="otpCode" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ (6 Ø£Ø±Ù‚Ø§Ù…)">
      <button id="verifyOtpBtn">ØªØ£ÙƒÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯ ÙˆØ§Ù„Ø¯Ø®ÙˆÙ„</button>
    </div>

    <div class="link" onclick="backToLogin()">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { 
    getAuth, 
    createUserWithEmailAndPassword, 
    signInWithEmailAndPassword, 
    RecaptchaVerifier, 
    signInWithPhoneNumber 
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ
const firebaseConfig = {
  apiKey: "AIzaSyC4l0BaiwsxguCFPWBEF_5xoUv45PWjHqk",
  authDomain: "nabdapp-3a077.firebaseapp.com",
  projectId: "nabdapp-3a077",
  storageBucket: "nabdapp-3a077.appspot.com",
  messagingSenderId: "675031985272",
  appId: "1:675031985272:web:5f86cc21c28062cd65d18d"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
auth.languageCode = 'ar';

// Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†ÙˆØ§ÙØ°
window.toggleForms = () => {
  document.getElementById("loginForm").classList.toggle("hidden");
  document.getElementById("registerForm").classList.toggle("hidden");
};

window.showForgot = () => {
  document.getElementById("loginForm").classList.add("hidden");
  document.getElementById("forgotForm").classList.remove("hidden");
};

window.backToLogin = () => {
  document.getElementById("loginForm").classList.remove("hidden");
  document.getElementById("forgotForm").classList.add("hidden");
  document.getElementById("registerForm").classList.add("hidden");
};

// ØªÙ‡ÙŠØ¦Ø© reCAPTCHA Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
function initRecaptcha() {
    if (!window.recaptchaVerifier) {
        window.recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', {
            'size': 'normal',
            'callback': (response) => {
                console.log("ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒØ§Ø¨ØªØ´Ø§");
            }
        });
    }
}

// 1. Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯ OTP
document.getElementById("sendOtpBtn").onclick = async () => {
  let phone = document.getElementById("recoverPhone").value.trim();
  const countryCode = document.getElementById("recoverCountryCode").value;

  // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø±Ù‚Ù…: Ø¥Ø°Ø§ Ø¨Ø¯Ø£ Ø¨Ù€ 0 Ù†Ø­Ø°ÙÙ‡ (Ù…Ø«Ù„Ø§Ù‹ 079 ØªØµØ¨Ø­ 79)
  if (phone.startsWith('0')) {
      phone = phone.substring(1);
  }

  const fullPhone = countryCode + phone;

  if (phone.length < 9) return alert("âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙ ØµØ­ÙŠØ­");

  initRecaptcha();

  try {
    const confirmationResult = await signInWithPhoneNumber(auth, fullPhone, window.recaptchaVerifier);
    window.confirmationResult = confirmationResult;
    document.getElementById("otpSection").classList.remove("hidden");
    document.getElementById("sendOtpBtn").classList.add("hidden");
    alert("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø¨Ù†Ø¬Ø§Ø­");
  } catch (error) {
    console.error(error);
    alert("âš ï¸ Ø®Ø·Ø£ Ø¯Ø§Ø®Ù„ÙŠ: " + error.message);
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙƒØ§Ø¨ØªØ´Ø§ ÙÙŠ Ø­Ø§Ù„ Ø§Ù„Ø®Ø·Ø£
    if (window.recaptchaVerifier) {
        window.recaptchaVerifier.render().then(widgetId => {
            grecaptcha.reset(widgetId);
        });
    }
  }
};

// 2. ØªØ£ÙƒÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯
document.getElementById("verifyOtpBtn").onclick = async () => {
  const code = document.getElementById("otpCode").value.trim();
  try {
    await window.confirmationResult.confirm(code);
    alert("âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ù†Ø¬Ø§Ø­! Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„...");
    window.location.href = "index.html";
  } catch (error) {
    alert("âŒ Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØªÙ‡");
  }
};

// 3. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„
document.getElementById("loginBtn").onclick = async () => {
  const email = document.getElementById("loginEmail").value.trim();
  const pass = document.getElementById("loginPassword").value;
  try {
    await signInWithEmailAndPassword(auth, email, pass);
    window.location.href = "index.html";
  } catch (err) {
    alert("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±");
  }
};

// 4. Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨
document.getElementById("registerBtn").onclick = async () => {
  const fName = document.getElementById("firstName").value.trim();
  const email = document.getElementById("regEmail").value.trim();
  const pass = document.getElementById("password").value;
  
  if (!email || !pass || !fName) return alert("âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

  try {
    const cred = await createUserWithEmailAndPassword(auth, email, pass);
    await addDoc(collection(db, "users"), {
      uid: cred.user.uid,
      name: fName,
      email: email,
      createdAt: new Date()
    });
    alert("âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨");
    window.location.href = "index.html";
  } catch (err) {
    alert("âš ï¸ " + err.message);
  }
};
</script>
</body>
</html>
