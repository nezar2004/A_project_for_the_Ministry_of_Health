<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>نظام نبض - وزارة الصحة</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root { --primary: #8D6E63; --accent: #5D4037; --text: #3E2723; }
    body { font-family: "Tajawal", sans-serif; background-color: #D7CCC8; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
    .container { background: white; padding: 40px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 450px; text-align: center; }
    h2 { color: var(--accent); margin-bottom: 25px; font-weight: 700; }
    input, select { width: 100%; padding: 15px; margin: 10px 0; border: 1px solid #E0E0E0; border-radius: 12px; font-size: 15px; font-family: 'Tajawal'; background: #FAFAFA; box-sizing: border-box; }
    .phone-row { display: flex; gap: 10px; }
    .phone-row select { width: 35%; }
    button { width: 100%; padding: 15px; background-color: var(--accent); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.3s; margin-top: 15px; }
    button:hover { background-color: var(--primary); }
    .link { margin-top: 20px; color: var(--primary); cursor: pointer; font-size: 14px; text-decoration: none; display: block; }
    .hidden { display: none; }
    #recaptcha-container { margin: 15px 0; display: flex; justify-content: center; }
  </style>
</head>
<body>

<div class="container">
  
  <div id="loginForm">
    <h2>تسجيل الدخول</h2>
    <input type="text" id="loginNationalID" placeholder="الرقم الوطني">
    <input type="password" id="loginPassword" placeholder="كلمة المرور">
    <button id="loginBtn">دخول</button>
    <div class="link" onclick="showForm('registerForm')">إنشاء حساب جديد (لأول مرة)</div>
    <div class="link" onclick="showForm('forgotForm')">نسيت كلمة المرور؟</div>
  </div>

  <div id="registerForm" class="hidden">
    <h2>إنشاء حساب جديد</h2>
    <input type="text" id="regFirstName" placeholder="الاسم الأول">
    <input type="text" id="regLastName" placeholder="اسم العائلة">
    <input type="text" id="regNationalID" placeholder="الرقم الوطني (10 أرقام)">
    
    <div class="phone-row">
      <select id="regCountryCode"><option value="+962">JO +962</option></select>
      <input type="text" id="regPhone" placeholder="7XXXXXXXX">
    </div>

    <input type="date" id="regBirthday">
    <select id="regGender">
      <option value="">الجنس</option>
      <option value="male">ذكر</option>
      <option value="female">أنثى</option>
    </select>
    
    <input type="password" id="regPassword" placeholder="ضبط كلمة مرور جديدة">
    
    <div id="recaptcha-container"></div>
    <button id="regSendCodeBtn">تأكيد رقم الهاتف وإنشاء الحساب</button>

    <div id="regOtpSection" class="hidden">
        <input type="text" id="regOtpCode" placeholder="أدخل كود التحقق (SMS)">
        <button id="verifyRegBtn">إنهاء عملية التسجيل</button>
    </div>
    <div class="link" onclick="showForm('loginForm')">لديك حساب؟ سجل دخولك</div>
  </div>

  <div id="forgotForm" class="hidden">
    <h2>استعادة الدخول</h2>
    <p style="font-size: 13px; color: #777;">أدخل رقم هاتفك لتصلك رسالة كود الدخول</p>
    <div class="phone-row">
      <select><option value="+962">JO +962</option></select>
      <input type="text" id="recoverPhone" placeholder="7XXXXXXXX">
    </div>
    <button id="recoverBtn">إرسال كود التحقق</button>
    <div class="link" onclick="showForm('loginForm')">العودة لتسجيل الدخول</div>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, RecaptchaVerifier, signInWithPhoneNumber } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getFirestore, collection, addDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyC4l0BaiwsxguCFPWBEF_5xoUv45PWjHqk",
  authDomain: "nabdapp-3a077.firebaseapp.com",
  projectId: "nabdapp-3a077",
  storageBucket: "nabdapp-3a077.appspot.com",
  messagingSenderId: "675031985272",
  appId: "1:675031985272:web:5f86cc21c28062cd65d18d"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

window.showForm = (id) => {
    document.querySelectorAll('.container > div').forEach(div => div.classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
};

// 1. تسجيل الدخول: يوجه المستخدم إلى index.html
document.getElementById("loginBtn").onclick = async () => {
    const nid = document.getElementById("loginNationalID").value.trim();
    const pass = document.getElementById("loginPassword").value;

    const q = query(collection(db, "users"), where("nationalID", "==", nid), where("password", "==", pass));
    const snapshot = await getDocs(q);

    if (!snapshot.empty) {
        alert("✅ أهلاً بك.. تم تسجيل دخولك بنجاح");
        window.location.href = "index.html"; 
    } else {
        alert("❌ عذراً، الرقم الوطني أو كلمة المرور غير صحيحة");
    }
};

// 2. إرسال كود التحقق لإنشاء حساب
document.getElementById("regSendCodeBtn").onclick = async () => {
    const phone = document.getElementById("regPhone").value.trim();
    const fullPhone = "+962" + (phone.startsWith('0') ? phone.substring(1) : phone);
    
    window.recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', { 'size': 'normal' });

    try {
        const confirmationResult = await signInWithPhoneNumber(auth, fullPhone, window.recaptchaVerifier);
        window.regConfirm = confirmationResult;
        document.getElementById("regOtpSection").classList.remove("hidden");
        document.getElementById("regSendCodeBtn").classList.add("hidden");
        alert("✅ تم إرسال الكود إلى " + fullPhone);
    } catch (err) { alert("⚠️ خطأ في الإرسال: " + err.message); }
};

// 3. إنهاء التسجيل: يحفظ البيانات ويوجه المستخدم إلى صفحة تسجيل الدخول 1login.html
document.getElementById("verifyRegBtn").onclick = async () => {
    const code = document.getElementById("regOtpCode").value;
    try {
        await window.regConfirm.confirm(code);
        await addDoc(collection(db, "users"), {
            name: document.getElementById("regFirstName").value + " " + document.getElementById("regLastName").value,
            nationalID: document.getElementById("regNationalID").value,
            password: document.getElementById("regPassword").value,
            phone: document.getElementById("regPhone").value,
            gender: document.getElementById("regGender").value,
            birthday: document.getElementById("regBirthday").value
        });
        alert("✅ تم إنشاء حسابك بنجاح! يرجى تسجيل الدخول.");
        window.location.href = "1login.html"; 
    } catch (err) { alert("❌ الكود المدخل غير صحيح"); }
};
</script>
</body>
</html>

